import { Meta } from '@storybook/blocks';

<Meta title="Documentation/Development"/>

# Development

1. [Prerequisites](#prerequisites)
2. [Quick start](#quick-start)
3. [General quick tips](#general-quick-tips)
4. [Create a new component](#create-a-new-component)
5. [Automated tests](#automated-tests)

- [Appendix 1: CLI command quick reference](#appendix-1-cli-command-quick-reference)
- [Appendix 2: Troubleshooting](./notes/troubleshooting.md)
- [Appendix 3: From-scratch environment setup on Windows](./notes/windows.md)

> [!NOTE]
> I use Windows for developing my projects locally and generally like to
> use [WSL](https://learn.microsoft.com/en-us/windows/wsl/) (Debian on WSL1) as my terminal, with PowerShell as my
> second
> choice (and where I do anything Windows-specific that I can't easily do in my WSL setup). All
> notes/docs/config/scripts
> throughout this project reflect this.

---
## Prerequisites

- PHP and [Composer](https://getcomposer.org) installed locally
- [Node](https://nodejs.org) installed locally
- Git installed locally
- [Sass](https://sass-lang.com) installed globally on your machine
- IDE of choice (I use [PHPStorm](https://www.jetbrains.com/phpstorm/))

Windows users can find more details
on [PHP, Composer, Node, and Sass setup in this document](./notes/windows.md).

---
## Quick start

1. Clone the repository from GitHub
2. Install dependencies, refresh autoloading, and redo symlinks:

```bash
npm run refresh:all
```
See Appendix 1 for more options if you don't need to do a full refresh.

3. Run the local web server and Storybook (at the same time i.e. two terminal windows) to see what you're working with!
```bash
npm run test:server
```
```bash
npm run test:storybook
```

### General quick tips

- When developing for the WordPress plugin, running with Xdebug on can slow things down. If loading the editor or saving
seems unduly slow, test with Xdebug off to confirm if it's just that or if you have an actual performance issue.

### Create a new component

1. To generate the boilerplate code for a new component, run the following command with `example` and `simple` replaced
with the desired component name and type. Valid types are `simple`, `complex`, and `wrapper`.

```bash
npm run generate component -- --name=example --type=simple
```

2. Add the SCSS file to `blocks.scss` or `template-parts.scss` (depending on what it is) in the WordPress plugin and [run Sass](./notes/sass.md) to compile it.[^1]
3. If you add a custom front-end JavaScript file, add it to `rollup.index.js` in the Core package and run Rollup (`npm run build`) to update the bundle.
4. Update the symlinks so the local web server/Storybook can access the CSS file: `npm run refresh:symlinks`
5. Add a file to `./test/browser/components` with a sample usage of the component. Add handling for `$_GET` parameters
to allow for different attributes to be tested.
6. Create a Storybook file in `./test/browser/stories`. // TODO - I plan on adding boilerplate generation of this too.

### Check for expected files

```bash
php ./scripts/healthcheck.php
```

### Compile assets in the Core package

#### CLI

Bundle component JS and its dependencies into a single file using Rollup:

```bash
npm run build
```

Compile a CSS file (or the global file) using Sass (replace `input.scss` and `output.css` with the actual filenames):

```bash
sass input.scss:output.css
```

#### PHPStorm file watchers

See the [PHPStorm file watcher](./notes/phpstorm.md#sass-file-watcher) notes for information on how to set up watchers to automatically compile SCSS and bundle JS on file save.


[^1]: Historically, I
always used Gulp with a plugin to import all component SCSS using a glob pattern, but because `@import` is being
deprecated in Sass that approach's days are numbered.

---
## Automated tests

See [testing notes](./notes/testing.md) for more information.

---
## Appendix 1: CLI command quick reference

### Dependencies

#### Convenience scripts

Run these from the root of the project.

| Command                       | Description                                                                                                  |
|-------------------------------|--------------------------------------------------------------------------------------------------------------|
| `npm run refresh:composer`    | Refresh Composer dependencies and autoloading for the root and all packages                                  |
| `npm run refresh:npm`         | Run `npm install` in the root and all packages, and `rollup` in packages that use it                         |
| `npm run refresh:symlinks`    | Refresh symlinks for the local web server and Storybook                                                      |
| `npm run refresh:all`         | Install/update Composer and NPM dependencies in the root and all packages + relink all symlinks              |
| `npm run refresh:autoload`    | Run `composer dump-autoload -o` for the root and all packages (skip updating dependencies)                   |
| `npm run refresh:npmpackages` | Run `npm install` and `rollup` in the packages only (skips installing/updating root dev deps like Storybook) |
| `npm run test:server`         | Run the local web server for component demos                                                                 |
| `npm run test:storybook`      | Run Storybook for component demos                                                                            |

#### Raw commands

These commands need to be run in the relevant folder. Running in the root will only run the command for the root, not the packages. `cd` into the package folder first if you want to run these for a package.

| Command                     | Description                                                                                                                                                                    |
|-----------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| `composer install`          | Install Composer dependencies as per `composer.json`                                                                                                                           |
| `composer update`           | Update Composer dependencies as per `composer.json`                                                                                                                            |
| `composer dump-autoload -o` | Refresh Composer autoloader after adding new dependencies or classes                                                                                                           |
| `npm install`               | Install all NPM dependencies as per `package.json`                                                                                                                             |
| `npm run build`             | Run Rollup to compile JS using the package's `rollup.config.js`. For example, for the `core` package this bundles all component JS files and their imports into a single file. |

### Component generation

Generate a new component (example):

```bash
npm run generate component -- --name=gallery --type=simple
```

Once you have added fields and docblock comments to a component, generate the JSON definition file (example):

```bash
php scripts/generate-json-defs.php --component Gallery
```

Or for a new base/abstract/parent component:

```bash
php scripts/generate-json-defs.php --base Renderable
```

Use the same command to update these after making changes.

You can also generate/update all JSON definition files at once:

```bash
php scripts/generate-json-defs.php
```

Then generate stories (example):

```bash
php scripts/generate-stories.php --component Container
```

If adding a "type" enum, regenerate the MDX documentation page for Storybook with:

```bash
php scripts/generate-enum-docs.php
```

Similarly, for a trait:

```bash
php scripts/generate-trait-docs.php
```

**Note:** The JSON definition and story generators require PHP 8.4+.

---
## Appendix 2: Troubleshooting

See [troubleshooting notes](./notes/troubleshooting.md).

## Appendix 3: From-scratch environment setup on Windows

See [Windows setup notes](./notes/windows.md).

